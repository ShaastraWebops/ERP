/* =
	jquery.eventCalendar.js
	version: 0.4;
	date: 28-05-2012
	authors: 
		Jaime Fernandez (@vissit)
		Nerea Navarro (@nereaestonta)
	company:	
		Paradigma Tecnologico (@paradigmate)
*/

$.fn.eventCalendar=function(a){function d(a,b){return a.date.toLowerCase()>b.date.toLowerCase()?1:-1}function e(a,d,e){var f=$("<div class='eventsCalendar-slider'></div>"),h=$("<div class='eventsCalendar-monthWrap'></div>"),i=$("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),j=$("<a href='#' class='arrow prev'><span>"+b.txt_prev+"</span></a><a href='#' class='arrow next'><span>"+b.txt_next+"</span></a>");$eventsCalendarDaysList=$("<ul class='eventsCalendar-daysList'></ul>"),date=new Date;if(!c.wrap.find(".eventsCalendar-slider").size()){c.wrap.prepend(f);f.append(h)}else{c.wrap.find(".eventsCalendar-slider").append(h)}c.wrap.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth");h.addClass("currentMonth").append(i,$eventsCalendarDaysList);if(a==="current"){day=date.getDate();f.append(j)}else{date=new Date(c.wrap.attr("data-current-year"),c.wrap.attr("data-current-month"),1,0,0,0);day=0;moveOfMonth=1;if(a==="prev"){moveOfMonth=-1}date.setMonth(date.getMonth()+moveOfMonth);var k=new Date;if(date.getMonth()===k.getMonth()){day=k.getDate()}}var d=date.getFullYear(),e=date.getMonth(),l=e+1;if(a!="current"){g(b.eventsLimit,d,e,false,a)}c.wrap.attr("data-current-month",e).attr("data-current-year",d);i.find(".monthTitle").html(b.monthNames[e]+" "+d);var m=32-(new Date(d,e,32)).getDate();var n=[];if(b.showDayAsWeeks){$eventsCalendarDaysList.addClass("showAsWeek");if(b.showDayNameInCalendar){$eventsCalendarDaysList.addClass("showDayNames");var o=0;if(b.startWeekOnMonday){o=1}for(;o<7;o++){n.push('<li class="eventsCalendar-day-header">'+b.dayNamesShort[o]+"</li>");if(o===6&&b.startWeekOnMonday){n.push('<li class="eventsCalendar-day-header">'+b.dayNamesShort[0]+"</li>")}}}dt=new Date(d,e,1);var p=dt.getDay();if(b.startWeekOnMonday){p=dt.getDay()-1}if(p<0){p=6}for(o=p;o>0;o--){n.push('<li class="eventsCalendar-day empty"></li>')}}for(dayCount=1;dayCount<=m;dayCount++){var q="";if(day>0&&dayCount===day){q="current"}n.push('<li id="dayList_'+dayCount+'" rel="'+dayCount+'" class="eventsCalendar-day '+q+'"><a href="#">'+dayCount+"</a></li>")}$eventsCalendarDaysList.append(n.join(""));f.css("height",h.height()+"px")}function f(a){var b=a.length,c=a.charAt(b-1),d;if(b===2&&a.charAt(0)==="1"){d="th"}else{if(c==="1"){d="st"}else if(c==="2"){d="nd"}else if(c==="3"){d="rd"}else{d="th"}}return a+d}function g(a,d,e,f,g){var a=a||0;var d=d||"";var f=f||"";if(typeof e!="undefined"){var e=e}else{var e=""}c.wrap.find(".eventsCalendar-loading").fadeIn();if(b.jsonData){b.cacheJson=true;c.eventsJson=b.jsonData;h(c.eventsJson,a,d,e,f,g)}else if(!b.cacheJson||!g){$.getJSON(b.eventsjson+"?limit="+a+"&year="+d+"&month="+e+"&day="+f,function(b){c.eventsJson=b;h(c.eventsJson,a,d,e,f,g)}).error(function(){j("error getting json: ")})}else{h(c.eventsJson,a,d,e,f,g)}}function h(a,e,g,h,i,j){directionLeftMove="-="+c.directionLeftMove;eventContentHeight="auto";subtitle=c.wrap.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle");if(!j){subtitle.html(b.txt_NextEvents);eventContentHeight="auto";directionLeftMove="-=0"}else{if(i!=""){subtitle.html(b.txt_SpecificEvents_prev+b.monthNames[h]+" "+f(i)+" "+b.txt_SpecificEvents_after)}else{subtitle.html(b.txt_SpecificEvents_prev+b.monthNames[h]+" "+b.txt_SpecificEvents_after)}if(j==="prev"){directionLeftMove="+="+c.directionLeftMove}else if(j==="day"||j==="month"){directionLeftMove="+=0";eventContentHeight=0}}c.wrap.find(".eventsCalendar-list").animate({opacity:b.moveOpacity,left:directionLeftMove,height:eventContentHeight},b.moveSpeed,function(){c.wrap.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var f=[];a=$(a).sort(d);if(a.length){var g="";if(!b.showDescription){g="hidden"}var j="_self";if(b.openEventInNewWindow){j="_target"}var k=0;$.each(a,function(a,b){var d=new Date(parseInt(b.date)),l=d.getFullYear(),m=d.getMonth(),n=d.getDate();if(e===0||e>k){var o=m+1,p=d.getHours(),q=d.getMinutes();if(q<=9){q="0"+q}if((h===false||h==m)&&(i==""||i==n)){if(h===false&&d<new Date){}else{eventStringDate=n+"/"+o+"/"+l;f.push('<li id="'+a+'" class="'+b.type+'"><time datetime="'+d+'"><em>'+eventStringDate+"</em><small>"+p+":"+q+'</small></time><a href="'+b.url+'" target="'+j+'" class="eventTitle">'+b.title+'</a><p class="eventDesc '+g+'">'+b.description+"</p></li>");k++}}}if(l==c.wrap.attr("data-current-year")&&m==c.wrap.attr("data-current-month")){c.wrap.find(".currentMonth .eventsCalendar-daysList #dayList_"+n).addClass("dayWithEvents")}})}if(!f.length){f.push('<li class="eventsCalendar-noEvents"><p>'+b.txt_noEvents+"</p></li>")}c.wrap.find(".eventsCalendar-loading").hide();c.wrap.find(".eventsCalendar-list").html(f.join(""));c.wrap.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},b.moveSpeed)});k()}function i(){c.wrap.find(".arrow").click(function(a){a.preventDefault();if($(this).hasClass("next")){e("next");var d="-="+c.directionLeftMove}else{e("prev");var d="+="+c.directionLeftMove}c.wrap.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:b.moveOpacity,left:d},b.moveSpeed,function(){c.wrap.find(".eventsCalendar-monthWrap.oldMonth").remove()})})}function j(a){c.wrap.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+a+" "+b.eventsjson+"</span>")}function k(){c.directionLeftMove=c.wrap.width();c.wrap.find(".eventsCalendar-monthWrap").width(c.wrap.width()+"px");c.wrap.find(".eventsCalendar-list-wrap").width(c.wrap.width()+"px")}var b=$.extend({},$.fn.eventCalendar.defaults,a);var c={wrap:"",directionLeftMove:"300",eventsJson:{}};this.each(function(){c.wrap=$(this);c.wrap.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>");if(b.eventsScrollable){c.wrap.find(".eventsCalendar-list-content").addClass("scrollable")}k();$(window).resize(function(){k()});e("current");g(b.eventsLimit,false,false,false,false);i();c.wrap.find(".eventsCalendar-day a").live("click",function(a){a.preventDefault();var b=c.wrap.attr("data-current-year"),d=c.wrap.attr("data-current-month"),e=$(this).parent().attr("rel");g(false,b,d,e,"day")});c.wrap.find(".monthTitle").live("click",function(a){a.preventDefault();var d=c.wrap.attr("data-current-year"),e=c.wrap.attr("data-current-month");g(b.eventsLimit,d,e,false,"month")})});c.wrap.find(".eventsCalendar-list .eventTitle").live("click",function(a){if(!b.showDescription){a.preventDefault();var d=$(this).parent().find(".eventDesc");if(!d.find("a").size()){var e=$(this).attr("href");var f=$(this).attr("target");d.append('<a href="'+e+'" target="'+f+'" class="bt">'+b.txt_GoToEventUrl+"</a>")}if(d.is(":visible")){d.slideUp()}else{if(b.onlyOneDescription){c.wrap.find(".eventDesc").slideUp()}d.slideDown()}}});};$.fn.eventCalendar.defaults={eventsjson:"js/events.json",eventsLimit:4,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],txt_noEvents:"There are no events in this period",txt_SpecificEvents_prev:"",txt_SpecificEvents_after:"events:",txt_next:"next",txt_prev:"prev",txt_NextEvents:"Next events:",txt_GoToEventUrl:"See the event",showDayAsWeeks:true,startWeekOnMonday:true,showDayNameInCalendar:true,showDescription:false,onlyOneDescription:true,openEventInNewWindow:false,eventsScrollable:false,moveSpeed:500,moveOpacity:.15,jsonData:"",cacheJson:true}

