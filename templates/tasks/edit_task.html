{% extends "base_portal.html" %}

{% block title %}
{{ block.super }} 

{% if is_new_task %}
Create a New Task
{% else %}
Edit Task
{% endif %}
{% endblock title %}

{% block form_stuff %}
<link href="{{ MEDIA_URL }}css/datepicker.css" rel="stylesheet">
<div align="center">
  <div class="rbroundbox"> 
    <div class="rbtop">
      <div>
	<div>
	</div>
      </div>
    </div>
    <div class="rbcontentwrap"> 
      <div class="rbcontent"> 
	{% if is_new_task %}
	<h2>Create a New Task</h2>
	{% else %}
	<h2>Edit Task</h2>
	{% endif %}
      </div>
    </div>
    <!-- /rbcontent --> 
    <div class="rbbot">
      <div>
	<div>
	</div>
      </div>
    </div> 
  </div>
  <!-- /rbroundbox --> 

  {# The Template Form (hidden) #}
  <div class="template-form">   
    <div class="rbroundbox">
      <div class="rbtop">
    	<div>
    	  <div>
    	  </div>
    	</div>
      </div>
      <div class="rbcontentwrap">
    	<div class="rbcontent">
	  {% include "tasks/subtask_form.html" %}
    	</div>
      </div>
      <!-- /rbcontent -->
      <div class="rbbot">
    	<div>
    	  <div>
    	  </div>
    	</div>
      </div>
    </div>
    <!-- /rbroundbox --> 
  </div>
  <form action="" method="post">
    {% csrf_token %}
    <div class="rbroundbox"> 
      <div class="rbtop">
	<div>
	  <div>
	  </div>
	</div>
      </div>
      <div class="rbcontentwrap"> 
	<div class="rbcontent"> 
<div class="well">
	  <table cellpadding="4">
	    {% if is_new_task %}
	    <tr>
	      <th>Department: </th>
	      <td>{{ user_dept_name }} </td>
	    </tr>
	    <tr>
	      <th>Creator: </th>
	      <td>{{ user_name }} </td>
	    </tr>
	    {% else %}
	    <tr>
	      <th>Department: </th>
	      <td>{{ curr_task.creator.get_profile.department.Dept_Name }} </td>
	    </tr>
	    <tr>
	      <th>Creator: </th>
	      <td>{{ curr_task.creator.get_profile.name }} </td>
	    </tr>
	    {% endif %}
	    {{ task_form.as_table }}
	  </table>
</div>
	</div>
      </div>
      <!-- /rbcontent --> 
      <div class="rbbot">
	<div>
	  <div>
	  </div>
	</div>
      </div> 
    </div>
    <!-- /rbroundbox --> 
<div class="well">
    {% include "tasks/comments.html" %}
</div>

    <div class="rbroundbox"> 
      <div class="rbtop">
	<div>
	  <div>
	  </div>
	</div>
      </div>
      <div class="rbcontentwrap"> 
	<div class="rbcontent"> 
	  <h2>Subtasks</h2>
	  <!-- <p>Fill as many Subtasks as you want</p> -->
	</div>
      </div>
      <!-- /rbcontent --> 
      <div class="rbbot">
	<div>
	  <div>
	  </div>
	</div>
      </div> 
    </div>    
    <!-- /rbroundbox -->

    {{ subtaskfs.management_form }}
    {% for form in subtaskfs.forms %}

    <div class="visible-form">   
      <div class="rbroundbox">
	<div class="rbtop">
    	  <div>
    	    <div>
    	    </div>
    	  </div>
	</div>

	<div class="rbcontentwrap">
    	  <div class="rbcontent">
	    {% include "tasks/subtask_form.html" %}
    	  </div>
	</div>
	<!-- /rbcontent -->
	<div class="rbbot">
    	  <div>
    	    <div>
    	    </div>
    	  </div>
	</div>
      </div>
      <!-- /rbroundbox --> 
    </div>

    {% endfor %}
    
    <a href="#" id="add">Add a SubTask</a>

    <table>
      <tr>
	<td>
	  {% if is_new_task %}
	  <input type="submit" name = "Create" value="Create" />
	  {% else %}
	  <input type="submit" name = "Edit" value= "Submit" />
	  {% endif %}
	</td>
	<td>
	  <input type="hidden" name="next" value="../../home" />
	</td>
      </tr>
    </table>
  </form>
</div>
{% endblock form_stuff %}

{% block javascript %}
{{ block.super }}

<script type="text/javascript" src="{{ MEDIA_URL }}js/dynamic-formset.js"></script>

<script type="text/javascript">
$(document).ready(function() {
    var d = document.getElementById("li_task");
    var e = document.getElementById("li_task_icon");
    d.className = "active";
    e.className = e.className + " icon-white";
    
    $('#id_subtask_set-TOTAL_FORMS').val(($('[id^=id_subtask_set]')   //'#id_subtask_set-TOTAL_FORMS' value doesn't reset on page refresh, messing up subtask numbering for the formset.
                                    .filter('[id$=subject]')          //This code corrects it.
                                    .filter(function(){
                                        if ($(this).val()) {
                                            return true;
                                        }})
                                    .length));                       //end of '#id_subtask_set-TOTAL_FORMS' correction code.
    
    $('[id$=deadline]').each(function() {
        if ($(this).val()) //django default format of year-month-date
        { 
            if ($(this).val().indexOf("/")==-1)                //following code must execute only if date isn't of mm/dd/yyyy format
            {
                var splitdate = $(this).val().split("-");
                $(this).val(splitdate[1] + "/" + splitdate[2] + "/" + splitdate[0]); //display in datepicker format of month/date/year
            }
        }
        else
            $(this).val("08/01/2012"); //Date set: Aug 1st, 2012. Set a date close to usage date for easier navigation
    });
 });
</script>
<script src="js/google-code-prettify/prettify.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}js/bootstrap-datepicker.js"></script>
<script type="text/javascript">
$(function(){
    window.prettyPrint && prettyPrint();
    $('[id$=deadline]').datepicker({
        format: 'mm/dd/yyyy' //save mm dd yyyy format as django takes first bit as month and next as date
    });
});
</script>
{% endblock javascript %}
